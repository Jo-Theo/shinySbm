
### Sélection du modèle

```{r echo=FALSE}

if(R$sbm$modelName %in% c("bernoulli","poisson")){
  modelName <- stringr::str_to_title(R$sbm$modelName)
}else{
  modelName <- "Gaussien"
}

nb_models <- dim(R$sbm$storedModels)[1]

if(is_bipartite){
  bip_min <- paste0(' (',R$sbm$storedModels$rowBlocks[1],' ',R$upload$labels$row,
         ' et ',R$sbm$storedModels$colBlocks[1],' ',R$upload$labels$col,')')
  bip_max <- paste0(' (',R$sbm$storedModels$rowBlocks[nb_models],' ',R$upload$labels$row,
         ' et ',R$sbm$storedModels$colBlocks[nb_models],' ',R$upload$labels$col,')')
  bip_cur <- paste0(' (',R$sbm$nbBlocks[[1]],' ',R$upload$labels$row,
         ' et ',R$sbm$nbBlocks[[2]],' ',R$upload$labels$col,')')
  bip_best <- paste0(' (',R$sbm$storedModels$rowBlocks[[which.max(R$sbm$storedModels$ICL)]][[1]],
                     ' ',R$upload$labels$row,' et ',
                     R$sbm$storedModels$colBlocks[[which.max(R$sbm$storedModels$ICL)]][[1]],
                     ' ',R$upload$labels$col,')')
}else{
  bip_min <- ""
  bip_max <- ""
  bip_cur <- ""
  bip_best <- ""
}

nb_group_best <- R$sbm$storedModels$nbBlocks[[which.max(R$sbm$storedModels$ICL)]][[1]]

if(R$sbm$ICL != max(R$sbm$storedModels$ICL)){
  entrop_cur <- paste0("Contre ", round(max(R$sbm$storedModels$ICL),2), 
                       " pour le mod","\ue8","le le plus vraisemblant ","\ue0 ",
                       nb_group_best, " groupes ", bip_best,"." )
}else{
  entrop_cur <- paste0("Sur tout les SBM observ","\ue9","s ce mod","\ue8","le ","\ue0"," l'ICL la plus ","\ue9","l","\ue9","v","\ue9","e, c'est le plus vraisemblable.")
}

```


Suite à l'application du modèle sbm (`r modelName`), `r nb_models` modèles ont été trouvés avec pour chacun un nombre de groupes différent allant de `r R$sbm$storedModels$nbBlocks[1]` `r bip_min` à `r R$sbm$storedModels$nbBlocks[nb_models]` groupes`r bip_max`. 

Le modèle sélectionné dans ce document est à `r sum(R$sbm$nbBlocks)` groupes`r bip_cur`. L'ICL (Critère de vraisemblance intégrée sur données-complète) de ce modèle vaut `r R$sbm$ICL`. `r entrop_cur`


### Modèle sélectionné 

```{r block-prop, echo=FALSE,results='asis',fig.align = 'center', fig.width=12}

col_group_names <- paste0('Group_', R$upload$labels$col,'_',
           1:R$sbm$nbBlocks[[1+is_bipartite]])
row_group_names <- paste0('Group_', R$upload$labels$row,'_',
           1:R$sbm$nbBlocks[[1]])


if(is_bipartite){
  c(col_group_names,
    round_prop(R$sbm$blockProp$col)) %>% 
    matrix(ncol = 2) %>% 
    t %>% 
    as.data.frame() %>% 
    smalltable(title = 'Proportion des groupes en colonnes')  %>% 
    flextable::flextable_to_rmd()
  
  example_group <- round_prop(R$sbm$blockProp$col)[[R$sbm$nbBlocks[[1]]]]*100
  
  
  c(row_group_names,
    round_prop(R$sbm$blockProp$row)) %>%
    matrix(ncol = 2) %>%
    t %>%
    as.data.frame() %>%
    smalltable(title = 'Proportion des groupes en lignes')  %>% 
    flextable::flextable_to_rmd()
}else{
  c(row_group_names,
    round_prop(R$sbm$blockProp)) %>% 
    matrix(ncol = 2) %>% 
    t %>% 
    as.data.frame() %>% 
    smalltable(title = 'Proportion des groupes')  %>% 
    flextable::flextable_to_rmd()
  
  example_group <- round_prop(R$sbm$blockProp)[[R$sbm$nbBlocks[[1]]]]*100
}
```
<br>
Ici par exemple `r example_group`\% des `r R$upload$labels$row` sont dans le groupe `r col_group_names[[R$sbm$nbBlocks[[1]]]]`. 


```{r connectivity, echo=FALSE,results='asis',fig.align = 'center', fig.width=12}

connect_table <- R$sbm$connectParam$mean %>% 
  as.data.frame() %>% 
  `names<-`(col_group_names) %>% 
  dplyr::mutate(rn = row_group_names) %>% 
  dplyr::select(rn,dplyr::everything()) %>% 
  smalltable(header = T,rownames = T,
             title = paste0('Table de connectivit','\ue9')) 
if(R$sbm$modelName == "gaussian"){
  connect_table <- flextable::add_body_row(connect_table,top = F,
      values = c('Variance',as.character(round(R$sbm$connectParam$var[[1]],3)),""),
       colwidths = c(1,1,R$sbm$nbBlocks[[1+is_bipartite]]-1))
}


connect_table %>% 
  flextable::flextable_to_rmd()

```
<br> 
Les valeurs dans ce tableau sont les paramètres de connectivité du model sbm (`r modelName`). <br>
```{r echo=FALSE,results='asis'}
ex_index <- min(2,R$sbm$nbBlocks[[1+is_bipartite]])
example_val <- round(R$sbm$connectParam$mean[1,ex_index],nb_digits)
if(R$sbm$modelName == "bernoulli"){
  connect_paraph <- paste0("Par exemple, si l'on prend un noeud A dans le groupe ",
         row_group_names[[1]]," en lignes et un noeud B dans le groupe ",
         col_group_names[[ex_index]]," en colonnes. Alors le noeud A ","\ue0",
         " une probabilit","\ue9"," ",example_val," d'",
         "\uea","tre connect","\ue9"," au noeud B.")
}else if(R$sbm$modelName == "poisson"){
  connect_paraph <- paste0("Par exemple, les noeuds du groupe ",
         row_group_names[[1]]," en lignes et les noeuds du groupe ",
         col_group_names[[ex_index]]," en colonnes ont une connection valant en moyenne ",
         example_val," . On peut simuler leur connection par une loi de ",
         modelName," de param","\ue8","tre lamba = ",example_val," .")
}else{
  connect_paraph <- paste0("Par exemple, les noeuds du groupe ",
         row_group_names[[1]]," en lignes et les noeuds du groupe ",
         col_group_names[[ex_index]]," en colonnes ont une connection valant en moyenne ",
         example_val,
         " . On peut simuler leur connection par une loi Normale de param","\ue8",
         "tre mu = ", example_val," et sigma = ",
         round(R$sbm$connectParam$var[[1]],3)," .")
}
cat(connect_paraph)
```
<br>
Le modèle séléctionné possède une entropie (Indice globale de certitude d'appartenance aux groupes attribués) de `r R$sbm$entropy` .



