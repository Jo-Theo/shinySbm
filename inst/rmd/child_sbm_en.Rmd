
### Model selection

```{r description-sbm, echo=FALSE}
modelName <- stringr::str_to_title(R$sbm$modelName)

nb_models <- dim(R$sbm$storedModels)[1]

if (is_bipartite) {
  bip_min <- paste0(
    " (", R$sbm$storedModels$rowBlocks[1], " ", R$upload$labels$row,
    " and ", R$sbm$storedModels$colBlocks[1], " ", R$upload$labels$col, ")"
  )
  bip_max <- paste0(
    " (", R$sbm$storedModels$rowBlocks[nb_models], " ", R$upload$labels$row,
    " and ", R$sbm$storedModels$colBlocks[nb_models], " ", R$upload$labels$col, ")"
  )
  bip_cur <- paste0(
    " (", R$sbm$nbBlocks[[1]], " ", R$upload$labels$row,
    " and ", R$sbm$nbBlocks[[2]], " ", R$upload$labels$col, ")"
  )
  bip_best <- paste0(
    " (", R$sbm$storedModels$rowBlocks[[which.max(R$sbm$storedModels$ICL)]][[1]],
    " ", R$upload$labels$row, " and ",
    R$sbm$storedModels$colBlocks[[which.max(R$sbm$storedModels$ICL)]][[1]],
    " ", R$upload$labels$col, ")"
  )
} else {
  bip_min <- ""
  bip_max <- ""
  bip_cur <- ""
  bip_best <- ""
}

nb_group_best <- R$sbm$storedModels$nbBlocks[[which.max(R$sbm$storedModels$ICL)]][[1]]

if (R$sbm$ICL != max(R$sbm$storedModels$ICL)) {
  entrop_cur <- paste0(
    "The most likely model has an ILC of ",
    round(max(R$sbm$storedModels$ICL), 2),
    " for ",
    nb_group_best, " groups ", bip_best, "."
  )
} else {
  entrop_cur <- paste0("On all estimated SBM, the selected one is the most likely.")
}
```


Following application of the sbm model (`r modelName`), `r nb_models` models were estimated, each with a different number of groups ranging from `r R$sbm$storedModels$nbBlocks[1]` `r bip_min` to `r R$sbm$storedModels$nbBlocks[nb_models]` `r bip_max` groups.

The selected model in this document has `r sum(R$sbm$nbBlocks)` groups`r bip_cur`. The ICL of this model is `r R$sbm$ICL`. `r entrop_cur`.


### Selected model 

```{r block-proportion, echo=FALSE,results='asis'}
col_group_names <- paste0(
  R$upload$labels$col, "_",
  1:R$sbm$nbBlocks[[1 + is_bipartite]]
)
row_group_names <- paste0(
  R$upload$labels$row, "_",
  1:R$sbm$nbBlocks[[1]]
)


get_tables <- list()
if (is_bipartite) {
  get_tables[[1]] <- small_tbl(
    R$sbm$blockProp$col,
    col_group_names,
    "Proportion of groups in columns"
  )
  get_tables[[2]] <- small_tbl(
    R$sbm$blockProp$row,
    row_group_names,
    "Proportion of groups in lines"
  )

  example_group <- round_prop(R$sbm$blockProp$row)[[R$sbm$nbBlocks[[1]]]] * 100
} else {
  get_tables[[1]] <- small_tbl(
    R$sbm$blockProp,
    row_group_names,
    "Proportion of groups"
  )
  example_group <- round_prop(R$sbm$blockProp)[[R$sbm$nbBlocks[[1]]]] * 100
}

purrr::map(get_tables, ~ cat(.x, sep = "\n")) %>% invisible()
```
<br>
Here, for example, `r example_group`\% of the `r R$upload$labels$row` are in the `r row_group_names[[R$sbm$nbBlocks[[1]]]]` group. 

```{r block-connectivity, echo=FALSE,results='asis',fig.align = 'center', fig.width=12}
connect_table <- round(R$sbm$connectParam$mean, nb_digits) %>%
  as.data.frame() %>%
  `names<-`(paste0("**", col_group_names, "**")) %>%
  `rownames<-`(paste0("**", row_group_names, "**"))

if (R$sbm$modelName == "gaussian") {
  connect_table[nrow(connect_table) + 1, ] <- c(round(R$sbm$connectParam$var[[1]], 3), rep("", R$sbm$nbBlocks[[1 + is_bipartite]] - 1))
  row.names(connect_table)[nrow(connect_table)] <- "**Variance**"
}

connect_table %>%
  knitr::kable(caption = "Connectivity Table", format = "pipe")
```
<br> 
The values in this table are the connectivity parameters of the sbm model (`r modelName`).

```{r description-connectivity,echo=FALSE,results='asis'}
ex_index <- min(2, R$sbm$nbBlocks[[1 + is_bipartite]])
example_val <- round(R$sbm$connectParam$mean[1, ex_index], nb_digits)

if (R$sbm$modelName == "bernoulli") {
  connect_paraph <- paste0(
    "For example, if we take a node A in the group ",
    row_group_names[[1]], " in rows and a node B in the group ",
    col_group_names[[ex_index]], " in columns. Then node A ", "\ue0",
    "a probability ", example_val, " of being connected to node B."
  )
} else if (R$sbm$modelName == "poisson") {
  connect_paraph <- paste0(
    "For example, nodes in group ",
    row_group_names[[1]], " in rows and group nodes ",
    col_group_names[[ex_index]], " in columns have an average connection value of ",
    example_val, " . Their connection can be simulated by a ",
    modelName, " parameter lamba = ", example_val, " ."
  )
} else {
  connect_paraph <- paste0(
    "We can read that the nodes in group ",
    row_group_names[[1]], " in rows and group nodes ",
    col_group_names[[ex_index]], " in columns have an average connection value of ",
    example_val,
    " . We can simulate their connection using a Normal",
    " distribution with parameters mu = ",
    example_val, " and sigma = ",
    round(R$sbm$connectParam$var[[1]], 3), " ."
  )
}
cat(connect_paraph)
```
The selected model has an entropy (overall index of certainty of belonging to the assigned groups) of `r R$sbm$entropy` .
